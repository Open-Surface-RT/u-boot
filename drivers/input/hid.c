#include <dm.h>
#include <dm/devres.h>
#include <fdtdec.h>
#include <input.h>
#include <keyboard.h>
#include <log.h>
#include <stdio_dev.h>
#include <asm/io.h>
#include <asm/arch/clock.h>
#include <asm/arch/funcmux.h>
#include <linux/delay.h>
#include <linux/input.h>
#include <linux/types.h>
#include <i2c.h>
#include <asm/gpio.h>
#include <linux/types.h>

#include "hid.h"

typedef struct short_item {
    union {
        struct {
            u8 bSize : 2;
            u8 bType : 2;
            u8 bTag : 4;
            u8 data[1];
        };
        u8 raw[1];
    };
} short_item;

typedef struct long_item {
    u8 bSize : 2;
    u8 bType : 2;
    u8 bTag : 4;
    u8 bDataSize;
    u8 bLongItemTag;
    u8 *data;
} long_item;

typedef struct report_item {
    u8 tag;
    short_item short_item;
    long_item long_item;
} report_item;

/* tCover_1st_gen_report_descriptor_bin */
u8 report_desc[] = {
  0x05, 0x01, 0x09, 0x06, 0xa1, 0x01, 0x85, 0x01, 0x15, 0x00, 0x25, 0x01,
  0x75, 0x01, 0x95, 0x08, 0x05, 0x07, 0x19, 0xe0, 0x29, 0xe7, 0x81, 0x02,
  0x75, 0x08, 0x95, 0x0a, 0x19, 0x00, 0x29, 0x91, 0x26, 0xff, 0x00, 0x81,
  0x00, 0x05, 0x0c, 0x0a, 0xc0, 0x02, 0xa1, 0x02, 0x1a, 0xc1, 0x02, 0x2a,
  0xc6, 0x02, 0x95, 0x06, 0xb1, 0x03, 0xc0, 0xc0, 0x05, 0x01, 0x09, 0x02,
  0xa1, 0x01, 0x85, 0x02, 0x05, 0x09, 0x19, 0x01, 0x29, 0x05, 0x15, 0x00,
  0x25, 0x01, 0x95, 0x05, 0x75, 0x01, 0x81, 0x02, 0x95, 0x01, 0x75, 0x03,
  0x81, 0x03, 0x15, 0x81, 0x25, 0x7f, 0x75, 0x08, 0x95, 0x02, 0x05, 0x01,
  0x09, 0x30, 0x09, 0x31, 0x81, 0x06, 0xa1, 0x02, 0x09, 0x48, 0x15, 0x00,
  0x25, 0x01, 0x35, 0x01, 0x45, 0x10, 0x75, 0x02, 0x95, 0x01, 0xa4, 0xb1,
  0x02, 0x09, 0x38, 0x15, 0x81, 0x25, 0x7f, 0x35, 0x00, 0x45, 0x00, 0x75,
  0x08, 0x95, 0x01, 0x81, 0x06, 0xc0, 0xa1, 0x02, 0x09, 0x48, 0xb4, 0xb1,
  0x02, 0x35, 0x00, 0x45, 0x00, 0x75, 0x04, 0xb1, 0x03, 0x05, 0x0c, 0x0a,
  0x38, 0x02, 0x15, 0x81, 0x25, 0x7f, 0x75, 0x08, 0x81, 0x06, 0xc0, 0xc0,
  0x05, 0x0c, 0x09, 0x01, 0xa1, 0x01, 0x85, 0x03, 0x95, 0x01, 0x75, 0x10,
  0x15, 0x00, 0x26, 0xff, 0x03, 0x19, 0x00, 0x2a, 0xff, 0x03, 0x81, 0x00,
  0xc0, 0x06, 0x05, 0xff, 0x09, 0x01, 0xa1, 0x01, 0x85, 0x07, 0x15, 0x00,
  0x25, 0xff, 0x95, 0x02, 0x75, 0x08, 0x09, 0x20, 0x81, 0x02, 0x09, 0x22,
  0x91, 0x02, 0x15, 0x81, 0x25, 0x7f, 0x95, 0x20, 0x75, 0x08, 0x09, 0x21,
  0x81, 0x02, 0x09, 0x23, 0x91, 0x02, 0xc0
};
unsigned int report_desc_size = 235;

typedef enum bType {
    MAIN = 0,
    GLOBAL,
    LOCAL,
    RESERVED
} bType_t;

static int parse_short_item(short_item *si) {
    // assert first byte != LONG_ITEM_TAG
    u8 size = si->bSize;
    bType_t type = si->bType;
    bType_t tag = si->bTag;

    printf("bSize: %d, bType: %d, bTag: %d\n", size, (u8)type, (u8)tag);

    printf("%02x ", si->raw[0]); // print header
    for (int i = 0; i < size; i++) { // print data
        printf("%02x", si->data[i]);
    }

    return 0;
}

static int parse_long_item(long_item *li) {
    // assert first byte == LONG_ITEM_TAG
    printf("DataSize: %d, LongItemTag: %d\n", li->bDataSize, li->bLongItemTag);
    printf("Not implemented - not needed right now.\n");

    return 0;
}

#define LONG_ITEM_TAG ((u8)0xFE)

int parse_report_descriptor(void) {

    report_item *ri;
    int i = 0;
    while (i < report_desc_size) {
        ri = (report_item*)&report_desc[i];
        if (ri->tag == LONG_ITEM_TAG) {
            long_item *li = (long_item*)&report_desc[i];
            parse_long_item(li);
            i += li->bDataSize + 3;
        } else {
            short_item *si = (short_item*)&report_desc[i];
            parse_short_item(si);
            i += si->bSize + 1;
        }
    }


    return 0;
}
